using Microsoft.Web.WebView2.Core;
using Microsoft.Web.WebView2.WinForms;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Drawing;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace MultiTabWebView
{
    public partial class Form1 : Form
    {
        private Panel userControlPanel;
        private TabControl tabControl;
        private Panel webViewContainer;
        private GroupBox viewTypeGroupBox;

        private TextBox startIpTextBox;
        private NumericUpDown countNumericUpDown;
        private Button generateButton;
        private Button clearAllButton;

        private Dictionary<TabPage, List<WebView2>> tabWebViewMap;

        private System.Windows.Forms.Timer genTimer;

        private string _startIp = "";
        private int _genCount = 0;
        private int _genIndex = 0;

        public enum ViewType
        {
            Single,
            Double
        }

        public Form1()
        {
            InitializeComponent();
            tabWebViewMap = new Dictionary<TabPage, List<WebView2>>();

            // 5초마다 실행되는 타이머 생성 및 시작
            genTimer = new System.Windows.Forms.Timer();
            genTimer.Interval = 500; // 2초 (5000ms)
            genTimer.Tick += OnTimerTick;
            
        }

        // 타이머 Tick 이벤트 핸들러 함수
        private async void OnTimerTick(object sender, EventArgs e)
        {
            if (!IsValidIpAddress(_startIp)) return;
            if (_genIndex >= _genCount)
            {
                genTimer.Stop();
                return;
            }

            genTimer.Interval = 1500;

            var baseIp = IPAddress.Parse(_startIp);
            var ipBytes = baseIp.GetAddressBytes();

            // 마지막 옥텟 증가
            int newLastOctet = ipBytes[3] + _genIndex;
            if (newLastOctet > 255)
            {
                genTimer.Stop();
                MessageBox.Show("IP 주소 범위를 초과했습니다.", "경고", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            ipBytes[3] = (byte)newLastOctet;
            var currentIp = new IPAddress(ipBytes).ToString();

            await GenerateTabsAndWebViews(currentIp, 1);

            _genIndex++;
        }

        private async void GenerateButton_Click(object sender, EventArgs e)
        {
            generateButton.Enabled = false;

            try
            {
                _startIp = startIpTextBox.Text.Trim();
                _genCount = (int)countNumericUpDown.Value;

                if (!IsValidIpAddress(_startIp))
                {
                    MessageBox.Show("유효한 IP 주소를 입력해주세요.", "오류",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                //await GenerateTabsAndWebViews(startIp, count);

                _genIndex = 0;
                genTimer.Start(); // 타이머 시작
            }
            catch (Exception ex)
            {
                MessageBox.Show($"탭 생성 중 오류가 발생했습니다: {ex.Message}", "오류",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                generateButton.Enabled = true;
            }
        }

        private async Task GenerateTabsAndWebViews(string startIp, int count)
        {
            var baseIp = IPAddress.Parse(startIp);
            var ipBytes = baseIp.GetAddressBytes();

            for (int i = 0; i < count; i++)
            {
                // IP 생성 (마지막 옥텟 증가)
                var currentIpBytes = (byte[])ipBytes.Clone();
                currentIpBytes[3] = (byte)(currentIpBytes[3] + i);

                if (currentIpBytes[3] < ipBytes[3]) // 오버플로우 체크
                {
                    MessageBox.Show($"IP 주소 범위를 초과했습니다. ({i}번째에서 중단)", "경고",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    break;
                }

                var currentIp = new IPAddress(currentIpBytes);
                string tabName = $"{currentIp}";

                // 탭 페이지 생성
                var tabPage = new TabPage(tabName)
                {
                    BackColor = Color.White
                };

                // WebView2 컨트롤들 생성
                var webViews = await CreateWebViewsForTab(tabPage, currentIp.ToString());
                tabWebViewMap[tabPage] = webViews;

                tabControl.TabPages.Add(tabPage);
            }

            // 마지막 탭 선택
            //if (tabControl.TabPages.Count > 0)
            //{
            //    tabControl.SelectedIndex = tabControl.TabPages.Count - 1;
            //}
        }

        private async Task<List<WebView2>> CreateWebViewsForTab(TabPage tabPage, string ip)
        {
            var webViews = new List<WebView2>();

            var webView = new WebView2
            {
                Visible = false // 초기에는 숨김
            };

            // 뷰 타입에 따라 위치와 크기 설정
            webView.Dock = DockStyle.Fill;

            tabPage.Controls.Add(webView);
            webViews.Add(webView);

            // WebView2 초기화 및 DOMContentLoaded 핸들러 설정
            await InitializeWebView(webView, ip, 0);
         
            return webViews;
        }

        private async Task InitializeWebView(WebView2 webView, string ip, int index)
        {
            try
            {
                webView.NavigationCompleted += OnNavigationCompleted;
                webView.CoreWebView2InitializationCompleted += OnCoreWebView2InitializationCompleted;
                
                await webView.EnsureCoreWebView2Async();

                webView.CoreWebView2.DOMContentLoaded += CoreWebView2_DOMContentLoaded;


                // 초기 페이지 로드 (IP 기반 URL로 이동)
                string url = $"http://{ip}:4011";

                webView.Visible = true;
                webView.Source = new Uri(url);
                //webView.CoreWebView2.Navigate(url);
            }
            catch (Exception ex)
            {
                // 에러 시 에러 페이지 표시
                string errorHtml = $@"
                <!DOCTYPE html>
                <html>
                <head><title>연결 오류</title></head>
                <body style='font-family: Arial; padding: 20px; text-align: center;'>
                    <h2 style='color: red;'>연결 오류 22222</h2>
                    <p>IP: {ip} (View {index + 1})</p>
                    <p>오류: {ex.Message}</p>
                </body>
                </html>";

                webView.NavigateToString(errorHtml);
                webView.Visible = true;
            }
        }

        private void OnNavigationCompleted(object sender, CoreWebView2NavigationCompletedEventArgs e)
        {
            if (e.IsSuccess)
            {
                // 페이지 로드 완료 후 크기 조정

            }
        }

        private void OnCoreWebView2InitializationCompleted(object sender, CoreWebView2InitializationCompletedEventArgs e)
        {
            var webView = (Microsoft.Web.WebView2.WinForms.WebView2)sender;

            if (e.IsSuccess)
            {
                Console.WriteLine($"OnCoreWebView2InitializationCompleted => {webView.Source.AbsoluteUri}");

                // JavaScript API 추가
                //webView.CoreWebView2.AddWebResourceRequestedFilter("*", CoreWebView2WebResourceContext.All);
                //webView21.CoreWebView2.WebResourceRequested += OnWebResourceRequested;                
            }
        }

        private async void CoreWebView2_DOMContentLoaded(object sender, Microsoft.Web.WebView2.Core.CoreWebView2DOMContentLoadedEventArgs e)
        {
            try
            {
                var webView = (Microsoft.Web.WebView2.Core.CoreWebView2)sender;

                try
                {
                    string tSrc = webView.Source;
                    Uri uri = new Uri(tSrc);
                    string absolutePath = uri.AbsolutePath;

                    Debug.WriteLine($"[CoreWebView2_DOMContentLoaded] 서브경로: {absolutePath}, org: {tSrc}, Doc: {webView.DocumentTitle}");

                    // 듀얼뷰LPR 초기화면
                    if (absolutePath == "/cgi-bin/luci/")
                    {
                        if (webView.DocumentTitle == "camera - Event - LuCI")
                        {
                            string script = @"
                            
                            if (document.body)
                            {
                            const userNameInput2 = document.getElementsByName('luci_username')[0];
                            if (userNameInput2) {
                                userNameInput2.value = 'root';
                            }
                            const passwordInput2 = document.getElementsByName('luci_password')[0];
                            if (passwordInput2) {
                                passwordInput2.value = 'root';

                                passwordInput2.dispatchEvent(new Event('input', {
                                bubbles: true
                                }));
                            }
                            if(userNameInput2 && passwordInput2)
                            {
                                const loginButton = document.querySelector('input[type=""submit""][value=""Login""]');
                                if (loginButton) {
                                    loginButton.click();
                                }
                            }
                            }
                        ";

                            await webView.ExecuteScriptAsync(script);
                        }

                    }
                    // 싱글뷰LPR 로그인
                    else if (absolutePath == "/login")
                    {
                        string script = @"
                            if (document.body)
                            {
                            const userNameInput = document.querySelector('input[formcontrolname=""userName""]');
                            if (userNameInput) {
                                userNameInput.value = 'admin';
                            }
                            const passwordInput = document.querySelector('input[formcontrolname=""password""]');
                            if (passwordInput) {
                                passwordInput.value = 'admin';

                                passwordInput.dispatchEvent(new Event('input', {
                                bubbles: true
                                }));
                            }

                            if(userNameInput && passwordInput)
                            {
                                const signInButton = document.querySelector('.form-actions.right .blue-btn');
                                if (signInButton) {
                                    signInButton.click();
                                    setTimeout(function() {
                                        window.location.href = '/config/Event?menu=LPRInfo';
                                    }, 1000); // 1초 후 이동
                                }
                            }
                            }
                        ";

                        await webView.ExecuteScriptAsync(script);

                    }

                }
                catch(UriFormatException ex)
                {
                    Console.WriteLine($"URI 형식 오류: {ex.Message}");
                }

                // DOM이 로드된 후 실행할 JavaScript 코드
                /*
                string script = $@"
                            // 페이지에 정보 표시
                            if (document.body) 
                            {{
                                var info = document.createElement('div');
                                info.style.position = 'fixed';
                                info.style.top = '10px';
                                info.style.left = '10px';
                                info.style.background = 'rgba(0,0,0,0.7)';
                                info.style.color = 'white';
                                info.style.padding = '10px';
                                info.style.borderRadius = '5px';
                                info.style.zIndex = '9999';
                                info.innerHTML = 'Time: ' + new Date().toLocaleTimeString();
                                document.body.appendChild(info);
                                
                                // 3초 후 자동 제거
                                setTimeout(function() {{
                                    if (info.parentNode) {{
                                        info.parentNode.removeChild(info);
                                    }}
                                }}, 3000);
                            }}
                        ";
                */
                
            }
            catch (Exception ex)
            {
                // 에러 로깅 (필요시)
                MessageBox.Show($"DOMContentLoaded 핸들러 오류: {ex.Message}");
            }

        }

        private void TabControl_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (tabControl.SelectedTab == null) return;

            // 모든 WebView 숨기기
            foreach (var kvp in tabWebViewMap)
            {
                foreach (var webView in kvp.Value)
                {
                    webView.Visible = false;
                }
            }

            // 선택된 탭의 WebView만 보이기
            if (tabWebViewMap.ContainsKey(tabControl.SelectedTab))
            {
                foreach (var webView in tabWebViewMap[tabControl.SelectedTab])
                {
                    webView.Visible = true;
                }
            }
        }

        private void ClearAllButton_Click(object sender, EventArgs e)
        {
            if (tabControl.TabPages.Count == 0) return;

            var result = MessageBox.Show("모든 탭을 삭제하시겠습니까?", "확인", MessageBoxButtons.YesNo, MessageBoxIcon.Question);

            if (result == DialogResult.Yes)
            {
                // 모든 WebView 리소스 해제
                foreach (var kvp in tabWebViewMap)
                {
                    foreach (var webView in kvp.Value)
                    {
                        webView.Dispose();
                    }
                }

                tabWebViewMap.Clear();
                tabControl.TabPages.Clear();
            }
        }

        private bool IsValidIpAddress(string ip)
        {
            return IPAddress.TryParse(ip, out _);
        }

        protected override void OnFormClosed(FormClosedEventArgs e)
        {
            // 리소스 정리
            foreach (var kvp in tabWebViewMap)
            {
                foreach (var webView in kvp.Value)
                {
                    webView.Dispose();
                }
            }

            base.OnFormClosed(e);
        }



    }
}
